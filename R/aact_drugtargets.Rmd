---
title: 'Mining ClinicalTrials.gov for Target Hypotheses: AACT Drug-Targets Analysis'
author: "Jeremy Yang"
output:
  html_document:
    number_sections: yes
    toc: yes
---

# Introduction

* CTTI = Clinical Trials Transformation Initiative
* AACT = Aggregate Analysis of ClinicalTrials.gov
* According to website (March 2019), data is refreshed monthly.
* https://aact.ctti-clinicaltrials.org/
* https://github.com/ctti-clinicaltrials/aact
* https:/www.nextmovesoftware.com
* https://bitbucket.org/larsjuhljensen/tagger
* http://download.jensenlab.org/

## Input files:

* (CTTI AACT) `aact_studies.tsv`
* (CTTI AACT) `aact_drugs.tsv`
* (CTTI AACT) `aact_descriptions.tsv`
* (NextMove LeadMine) `aact_drugs_leadmine.tsv`
* (PubChem) `aact_drugs_smi_pubchem_cid.tsv`
* (PubChem) `aact_drugs_smi_pubchem_cid2inchi.tsv`
* (ChEMBL) `aact_drugs_inchi2chembl.tsv`
* (ChEMBL) `aact_drugs_chembl_activity_pchembl.tsv`
* (ChEMBL) `aact_drugs_chembl_target_component.tsv`
* (IDG TCRD/Pharos) `pharos_targets.tsv`
* (JensenLab Tagger) `aact_descriptions_tagger_matches.tsv`
* (JensenLab Dictionary) `diseases_entities.tsv`

> `nct_id` is the study ID.

```{r echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE)
base::date()
```

```{r setup, echo=TRUE, message=FALSE}
library(readr)
library(data.table)
library(stringr)
library(plotly, quietly=T)
```

```{r}
truncate.ellipsis <- function(txt, maxlen) {
  return (ifelse(nchar(txt)<maxlen, txt, sprintf("%s...", substr(txt, 1, maxlen-3))));
}
```


# Input studies and drugs
## Studies
Read file of all studies in AACT.

```{r studies_input, message=FALSE}
studies <- read_delim("data/aact_studies.tsv", "\t")
setDT(studies)
studies[["start_year"]] <- as.integer(format(studies$start_date, "%Y"))
n_studies_total <- nrow(studies)
sprintf("Total studies: %d ; unique NCT_IDs: %d", n_studies_total, uniqueN(studies$nct_id))
```

### Study references
Reference type `results_reference` may offer greater evidence, confidence.

```{r}
refs <- read_delim("data/aact_study_refs.tsv", "\t", col_types="ccccc")
setDT(refs)
refs[, id:=NULL]
sprintf("references: %d; NCT_IDs: %d; PMIDs: %d; results_references: %d", nrow(refs), 
        uniqueN(refs$nct_id),
        uniqueN(refs$pmid),
        nrow(refs[reference_type=="results_reference"]))
refs <- refs[, .(N_refs = .N, N_results_refs = sum(reference_type=="results_reference"), pmids=paste0(pmid, collapse="; "), citations=paste0(citation, collapse="\t")), by="nct_id"]
```


## Drugs 
Read file of all drugs in AACT.

* `id` is AACT ID.
* Note that one study may involve multiple drugs.
* At this point a "drug" is identified by a name.

```{r message=FALSE}
drugs <- read_delim("data/aact_drugs.tsv", "\t", col_types = "dcc")
setDT(drugs)
drugs <- drugs[order(drugs$name)]
sprintf("Unique drug names: %d ; unique intervention IDs: %d", uniqueN(drugs$name), uniqueN(drugs$id))
```

## Studies: Interventional drug studies only
Select only ___Interventional___ studies (`study_type`) associated with drugs (via `nct_id`).

```{r}
studies <- studies[study_type=="Interventional"]
n_studies_inter <- nrow(studies)
sprintf("Interventional studies: %d (%.1f%%)", n_studies_inter, 100*n_studies_inter/n_studies_total)
studies$phase[studies$phase == "N/A"] <- NA
studies <- studies[nct_id %in% drugs$nct_id]
n_studies_inter_drug <- nrow(studies)
sprintf("Interventional drug studies: %d ; unique NCT_IDs: %d", n_studies_inter_drug, uniqueN(studies$nct_id))
```


```{r}
drugs <- merge(drugs, studies, by="nct_id", all.x=T, all.y=F)
knitr::kable(
  merge(studies[, .(N_studies = .N), by="phase"], drugs[, .(N_drugs = .N), by="phase"], by="phase")[order(phase)], caption="Drug studies and drugs, by phase")
knitr::kable(drugs[, .(.N), by="overall_status"][order(-N)], caption="Drugs (itv_ids), by study overall_status")
```


## Drugs by study start_year
(To do: stack with study start_year.)
```{r counts_by_year, message=FALSE}
p1 <- plot_ly(type="bar", data=merge(studies[, .(N_studies = .N), by="start_year"], drugs[, .(N_drugs = .N), by="start_year"], by="start_year"), x = ~start_year, name="studies", y = ~N_studies) %>%
	add_trace(name="drugs", y = ~N_drugs) %>%
	layout(title="AACT: Studies and drugs vs. start_year", xaxis=list(range=c(1990, 2020), tickangle=-45), yaxis=list(title="N"),
	       barmode="stack",
	       margin=list(t=120), font=list(family="Monospace", size=20))
p1
```

## Drug-trials by Phase and Status

```{r studies_by_classification}
ax0 <- list(showline=F,zeroline=F,showticklabels=F,showgrid=F)
p2 <- plot_ly() %>%
  add_pie(data=drugs[, .(.N), by="phase"], labels=~phase, values=~N, sort=F,
          textinfo="label+percent", textposition="inside", domain=list(x=c(0, 0.5), y=c(0, 1))) %>%
  add_pie(data = drugs[, .(.N), by="overall_status"], labels=~overall_status, values=~N,
          textinfo = "label+percent", textposition="inside", domain=list(x = c(0.5, 1), y = c(0, 1))) %>%
  add_annotations(x = c(0.25, 0.75), y = c(-.1, -.1),
                  xanchor = "center", xref = "paper", yref = "paper", showarrow = F,
                  text = c("Phase", "Overall status"),
                  font = list(family = "Arial", size = 20)) %>%
  layout(title=paste0("AACT: Drug trials by Phase and Status<br>(N_total = ", nrow(drugs), ")"),
         xaxis=ax0, yaxis=ax0, margin=list(t=120), font=list(family="Arial", size=20), showlegend=F)
p2
```

# NextMove Leadmine Chemical NER
AACT drug names resolved to standard names and structures via SMILES.
Note that one name may include multiple chemicals.
Now we can use cheminformatically rigorous counts for drugs as active pharmaceutical ingredients (APIs).

```{r message=FALSE}
cner <- read_delim("data/aact_drugs_leadmine.tsv",  "\t", escape_double=F, trim_ws=T)
setDT(cner)
setnames(cner, old=c("DocName","ResolvedForm"), new=c("id","smiles"))
sprintf("Drug unique SMILES resolved by LeadMine: %d ; unique intervention IDs: %d", uniqueN(cner$smiles), uniqueN(cner$id))
```
## Chemical NER mentions
### Disambiguated totals by resolved structure (SMILES)

```{r}
cner_totals <- cner[!is.na(smiles), .(N_mentions = .N), by=c("smiles", "OriginalText")]
cner_totals <- cner_totals[order(smiles, OriginalText)]
cner_totals <- cner_totals[, .(N_mentions = sum(N_mentions), names=paste0(OriginalText, collapse="; ")), by=c("smiles")]
cner_totals <- cner_totals[order(-N_mentions)]
cner_totals[["smi2img"]] <- sprintf("<img src=\"http://localhost:8080/cdkdepict/depict/cow/svg?smi=%s&h=50&w=80&zoom=3\">", sapply(cner_totals$smiles, URLencode, reserved=T))
knitr::kable(cner_totals[1:20, .(smi2img, N_mentions, names)], caption="Top 20 drugs by total mentions")
```

### Chemical NER mentions resolved to structures (SMILES)

```{r}
drugs <- merge(drugs, cner, by="id")
drugs[["resolved_structure"]] <- !is.na(drugs$smiles)
sprintf("Drugs (drug names) with resolved structure: %d / %d (%.1f%%)", sum(drugs$resolved_structure), nrow(drugs), 100*sum(drugs$resolved_structure)/nrow(drugs))
```

### Chemical NER mentions by intervention ID.

```{r ner_by_itvid}
cner_this <- cner[!is.na(smiles), .(.N), by="id"]
sprintf("Mentions by intervention ID: %d / %d (%.1f%%)", nrow(cner_this), uniqueN(drugs$id), 100*nrow(cner_this)/uniqueN(drugs$id))
```

### Chemical NER mentions by trial (NCT ID).

```{r ner_by_trial}
cner <- merge(cner, drugs[,c("id", "nct_id")], by="id")
cner_this <- cner[!is.na(smiles), .(.N), by="nct_id"]
sprintf("Mentions by study: %d / %d (%.1f%%)", nrow(cner_this), uniqueN(drugs$nct_id), 100*nrow(cner_this)/uniqueN(drugs$nct_id))
```

### Chemical NER mentions by drug, i.e. name in AACT.

```{r ner_by_drug}
cner_this <- cner[!is.na(smiles), .(.N), by="OriginalText"]
sprintf("Mentions by drug name: %d / %d (%.1f%%)", nrow(cner_this), uniqueN(drugs$name), 100*nrow(cner_this)/uniqueN(drugs$name))
```

# PUBCHEM:
## Intervention IDs to CIDs from PubChem (via SMILES)

```{r pubchem_compounds_input, message=FALSE}
drug2cid <- read_delim("data/aact_drugs_smi_pubchem_cid.tsv", "\t", col_names=c("smiles","cid","names"))
setDT(drug2cid)
sprintf("PubChem SMILES2CID hits: %d / %d (%.1f%%)", sum(!is.na(drug2cid$cid)), nrow(drug2cid),
        100*sum(!is.na(drug2cid$cid))/nrow(drug2cid))
```
```{r pubchem_compounds}
drug2cid <- drug2cid[!is.na(cid)]
drug2cid <- drug2cid[cid!=0]
drug2cid <- merge(drug2cid, unique(drugs[,c("smiles","id")]), all.x=F, all.y=F, by="smiles")
setnames(drug2cid, old="id", new="itv_id")
drug2cid[, smiles:=NULL]
drug2cid[, names:=NULL]
drug2cid <- unique(drug2cid)
sprintf("Intervention IDs mapped to PubChem CIDs (via SMILES): %d", nrow(drug2cid))
write_delim(drug2cid, "data/aact_drugs_itvid2cid.tsv", delim="\t")
```

## InChIKeys from PubChem (via CIDs)

```{r pubchem_cid2inchi_input, message=FALSE}
pubchem <- read_delim("data/aact_drugs_smi_pubchem_cid2inchi.tsv", "\t")
sprintf("PubChem CIDs with InChIKeys: %d", nrow(pubchem))
```

# CHEMBL:
## ChEMBL molecule IDs, and properties (via InChIKeys)

```{r}
chembl_mol <- read_delim("data/aact_drugs_inchi2chembl.tsv", "\t", 
                         col_types=cols_only(molecule_chembl_id = col_character(), molecule_type = col_character(), structure_type = col_character(), pref_name=col_character(), max_phase=col_character(), therapeutic_flag=col_logical()))
sprintf("ChEMBL compounds mapped via InChIKeys: %d", nrow(chembl_mol))
```

## ChEMBL activities for mapped compounds
Select only activities with pChembl values for confidence.

```{r message=FALSE}
chembl_act <- read_delim("data/aact_drugs_chembl_activity_pchembl.tsv", "\t", col_types=cols_only(  activity_id = col_double(),
  assay_chembl_id = col_character(),
  assay_type = col_character(),
  document_chembl_id = col_character(),
  document_year = col_integer(),
  molecule_chembl_id = col_character(),
  molecule_pref_name = col_character(),
  parent_molecule_chembl_id = col_character(),
  pchembl_value = col_double(),
  published_type = col_character(),
  published_units = col_character(),
  published_value = col_double(),
  qudt_units = col_character(),
  relation = col_character(),
  src_id = col_double(),
  standard_relation = col_character(),
  standard_type = col_character(),
  standard_units = col_character(),
  standard_value = col_double(),
  target_chembl_id = col_character(),
  target_organism = col_character(),
  target_pref_name = col_character(),
  target_tax_id = col_integer(),
  text_value = col_logical(),
  type = col_character(),
  units = col_character(),
  uo_units = col_character(),
  value = col_double()))
sprintf("ChEMBL activities: %d", nrow(chembl_act))
sprintf("ChEMBL activities molecules: %d ; targets: %d ; documents: %d", uniqueN(chembl_act$molecule_chembl_id), uniqueN(chembl_act$target_chembl_id), uniqueN(chembl_act$document_chembl_id))
plot_ly(x=chembl_act$pchembl_value, type="histogram", nbinsx=20) %>%
  layout(title=paste0("AACT: ChEMBL Activities, pChembl values<br>(N_total = ", nrow(chembl_act), ")<br>pChembl = -log<sub>10</sub>({I|E|L}C50})"), xaxis=list(title="pChembl"), yaxis=list(title="N"),
         margin=list(t=140), font=list(family="Arial", size=20), showlegend=F)

```

## ChEMBL targets (via activities)

```{r message=FALSE}
chembl_tgt <- read_delim("data/aact_drugs_chembl_target_component.tsv", "\t")
sprintf("ChEMBL target proteins: %d", nrow(chembl_tgt))
```

# IDG/TCRD:

```{r message=FALSE}
tcrd_tgt <- read_delim("~/src/TCRD_tools/data/pharos_targets.tsv", "\t")
tgt <- merge(chembl_tgt, tcrd_tgt, all.x=T, all.y=F, by.x="accession", by.y="accession")
sprintf("ChEMBL target proteins mapped to TCRD (human): %d",
	nrow(tgt[!is.na(tgt$idgTDL),]))
setDT(tgt)
```

## Targets by organism (top 10):

```{r}
sprintf("Organisms: %d", uniqueN(tgt$organism))
org_counts <- tgt[, .(N_targets = .N), by = "organism"][order(-N_targets)]
knitr::kable(org_counts[1:10], caption="Targets by organism (top 10)")
```

## Human single-protein targets only.

```{r}
tgt <- tgt[organism=="Homo sapiens"]
sprintf("Human targets: %d", nrow(tgt))
knitr::kable(tgt[, .(.N), by="target_type"][order(-N)])
tgt <- tgt[target_type=="SINGLE PROTEIN"]
sprintf("Human single-protein targets: %d ; unique UniProts: %d", nrow(tgt), uniqueN(tgt$accession))

```

## Targets by IDG Target Development Level (TDL):

```{r}
tdls <- c("Tdark", "Tbio", "Tchem", "Tclin")
tdl_counts <- tgt[, .(.N), by = "idgTDL"]
tdl_counts$tdl_color <- ifelse(tdl_counts$idgTDL=="Tdark", "gray", ifelse(tdl_counts$idgTDL=="Tbio", "red", ifelse(tdl_counts$idgTDL=="Tchem", "green", ifelse(tdl_counts$idgTDL=="Tclin", "blue", NA))))
tdl_counts$idgTDL <- factor(tdl_counts$idgTDL, levels=tdls)
sprintf("%8s: %6d", tdl_counts$idgTDL, tdl_counts$N)
p3 <- plot_ly() %>%
	add_trace(type="bar", data=tdl_counts, x=~idgTDL, y=~N, marker=list(color=~tdl_color),
	          text=~N, textposition="auto") %>%
	layout(title="Targets by IDG Target Development Level (TDL)", 
	       margin=list(t=120), font=list(family="Arial", size=20))
p3
```

# JensenLab Tagger Diseases NER
With JensenLab DOID entities dictionary.
On descriptions from detailed_descriptions table.

* `serialno` corresponds with DOID.
* `id` is AACT primary key.

Likely false positives, manually removed:

* "CAN" = "Crouzon syndrome-acanthosis nigricans syndrome" (DOID:0111161)
* "FACE" = "Fanconi anemia complementation group E" (DOID:0111084)

```{r message=FALSE, echo=FALSE}
dner <- read_delim("data/aact_descriptions_tagger_matches.tsv", "\t", 
                   col_names = c("id", "term", "serialnm" ), col_types="c----c-c")
dent <- read_delim("/home/data/jensenlab/data/diseases_entities.tsv", "\t", col_names=c("serialnm", "doid"), col_types="c-c")
setDT(dner)
setDT(dent)
dner <- merge(dner, dent, by="serialnm", all.x=T, all.y=F)
descs <- read_delim("data/aact_descriptions.tsv", "\t", skip=1, col_names=c("id","nct_id"), col_types="cc-", escape_double=F, trim_ws=T)
dner <- merge(dner, descs, by="id", all.x=T, all.y=F)
dner[, id:=NULL]
dner[, serialnm:=NULL]
dner <- dner[grepl("^DOID:", doid)] #Why not? "AmyCo:8" etc.? TBE.
badterms <- c("can", "face")
dner <- dner[!(tolower(term) %in% badterms)]
```

## Disambiguated total disease mentions by DOID.

```{r}
dner_totals <- dner[, .(N_mentions = .N), by=c("doid", "term")]
dner_totals <- dner_totals[order(as.integer(sub("DOID:", "", doid)), term)]
dner_totals <- dner_totals[, .(N_mentions = sum(N_mentions), terms=paste0(term, collapse="; ")), by=c("doid")]
dner_totals <- dner_totals[order(-N_mentions)]
dner_totals$terms <- truncate.ellipsis(dner_totals$terms, 200)
knitr::kable(dner_totals[1:20], caption="Top 20 diseases by total mentions")
```

## Disease mentions by study.
Sort synonyms terms by frequency.

```{r}
dner <- dner[, .(N_mentions = .N), by=c("nct_id", "doid", "term")]
dner <- dner[order(nct_id, -N_mentions, -as.integer(sub("DOID:", "", doid)))]
dner <- dner[, .(N_mentions = sum(N_mentions), disease_terms=paste0(term, collapse=";")), by=c("nct_id", "doid")]
knitr::kable(dner[1:20], caption="Disease mentions by study")
```

# Identify and enumerate _drug, disease, target_ combinations associated by study (NCI_ID)
And include references.

## Aggregate disease mentions by study (NCT_ID)

```{r}
links <- dner
links$disease_term <- sub(";.*$", "", links$disease_terms)
links <- links[, .(N_disease_mentions = paste0(N_mentions, collapse="; "), disease_terms=paste0(disease_term, collapse="; "), doids = paste0(doid, collapse="; ")), by=c("nct_id")]
setkey(links, nct_id)
```

## Link to drugs
Keep only studies including both disease and drug mentions.

```{r}
drug_links <- unique(drugs[!is.na(smiles), .(nct_id, name, EntityText, smiles)])
drug_links <- drug_links[order(nct_id, smiles, EntityText, nchar(name))]
drug_links <- drug_links[, .(N_chem_mentions=length(name), names = paste0(name, collapse="; "), EntityTexts = paste0(EntityText, collapse="; "), smiles = paste0(smiles, collapse="; ")), by="nct_id"]
setkey(drug_links, nct_id)
links <- links[drug_links]
links <- links[!is.na(doids) & !is.na(smiles)]
sprintf("studies linked to 1+ drugs AND 1+ diseases: %d", uniqueN(links$nct_id))
```

## Link to targets


## Link to references




